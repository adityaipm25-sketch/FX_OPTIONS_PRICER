<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Derivatives Terminal â€” FX & Stocks (Retro)</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: "Courier New", monospace;
      margin: 20px;
      background: #000000;
      color: #00ff7f;
      line-height: 1.25;
    }
    h1 { color: #00ff7f; margin: 0 0 6px 0; text-shadow: 0 0 4px #00ff7f; letter-spacing: 1.5px; font-size: 20px; }
    p.subtitle { color: #00c060; margin: 2px 0 18px 0; font-size: 12px; }

    .tabs { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:14px; }
    .tab-btn {
      padding:6px 12px; border-radius:0; border:1px solid #00aa55; background:#000000;
      color:#00ff7f; cursor:pointer; font-size:12px; text-transform:uppercase;
    }
    .tab-btn.active { background:#00ff7f; color:#000000; border-color:#00ff7f; }

    .layout { display:flex; flex-wrap:wrap; gap:18px; }
    .panel { background:#000000; border-radius:0; border:1px solid #004422; padding:12px; box-shadow:0 0 8px #001808; }
    .panel.form-panel { max-width:420px; width:100%; }
    .panel.result-panel { flex:1; min-width:360px; }

    .form-grid { display:grid; grid-template-columns:1fr; gap:8px 12px; align-items:center; }
    @media (min-width:880px) { .form-grid.two-col { grid-template-columns:1fr 1fr; } }

    label { font-size:11px; color:#00ff7f; text-transform:uppercase; letter-spacing:0.8px; margin-bottom:4px; display:block; }
    .field { display:flex; flex-direction:column; gap:4px; }
    input[type="text"], input[type="number"], input[type="password"], select {
      padding:8px 10px; border-radius:0; border:1px solid #007744; background:#000000; color:#00ff7f; font-size:13px; height:36px;
    }
    input::placeholder { color:#007744; font-size:12px; }
    input:focus, select:focus { outline:none; border-color:#00ff7f; box-shadow:0 0 6px #00ff7f; }

    .inline-row { display:flex; align-items:center; gap:8px; margin-top:4px; font-size:12px; }
    .inline-row input[type="checkbox"] { width:16px; height:16px; margin:0; accent-color:#00ff7f; }

    button {
      margin-top:8px; padding:8px 14px; border-radius:0; border:1px solid #00ff7f; cursor:pointer; background:#000000;
      color:#00ff7f; font-weight:700; font-size:12px; text-transform:uppercase; height:38px;
    }
    button:hover { background:#00ff7f; color:#000000; box-shadow:0 0 8px #00ff7f; }

    hr { border:none; border-top:1px solid #003315; margin:12px 0; }
    .error { margin-top:6px; color:#ff5555; font-size:12px; }

    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:12px; }
    th, td { border:1px solid #004422; padding:6px 8px; text-align:left; vertical-align:middle; }
    th { background:#001a0c; color:#00ff7f; font-size:12px; }
    tr:nth-child(even) td { background:#000a04; }

    .muted { color:#00aa55; font-size:12px; }
    .section-title { font-size:13px; margin:0 0 6px 0; text-transform:uppercase; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .chart-container { margin-top:12px; }
    canvas { max-width:100%; display:block; }
    .small-note { font-size:11px; color:#007744; margin-top:-2px; }

    /* Added styles for news section */
    .card {
      background: #001000;
      border: 1px solid #004422;
      border-radius: 4px;
      overflow: hidden;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .card-img-top {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    .btn-primary {
      background-color: #007744;
      border-color: #007744;
    }
    .btn-primary:hover {
      background-color: #00ff7f;
      border-color: #00ff7f;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
  <h1>DERIVATIVES ANALYTICS TERMINAL</h1>
  <p class="subtitle">FX & EQUITY OPTIONS â€” PRICING â€¢ GREEKS â€¢ CHAINS â€¢ SCENARIO ANALYSIS â€¢ MODEL COMPARISON</p>

  <div class="tabs">
    <button class="tab-btn {% if active_tab == 'chart' %}active{% endif %}" type="button" onclick="showTab('chart')">Market Candles</button>
    <button class="tab-btn {% if active_tab == 'fx' %}active{% endif %}" type="button" onclick="showTab('fx')">FX Pricing</button>
    <button class="tab-btn {% if active_tab == 'equity' %}active{% endif %}" type="button" onclick="showTab('equity')">Stock Pricing</button>
    <button class="tab-btn {% if active_tab == 'fx_chain' %}active{% endif %}" type="button" onclick="showTab('fx_chain')">FX Option Chain</button>
    <button class="tab-btn {% if active_tab == 'equity_chain' %}active{% endif %}" type="button" onclick="showTab('equity_chain')">Stock Option Chain</button>
    <button class="tab-btn {% if active_tab == 'scenario' %}active{% endif %}" type="button" onclick="showTab('scenario')">Scenario Analysis</button>
    <button class="tab-btn {% if active_tab == 'comparison' %}active{% endif %}" type="button" onclick="showTab('comparison')">Model Comparison</button>
  </div>

  <!-- MARKET CANDLES TAB -->
  <div id="chart-tab" class="tab-content {% if active_tab == 'chart' %}active{% endif %}">
    <div class="layout">
      <div class="panel form-panel">
        <form method="post" novalidate>
          <input type="hidden" name="tab_type" value="chart" />
          <div class="form-grid">
            <div class="field">
              <label for="chart_symbol">Symbol</label>
              <input id="chart_symbol" name="chart_symbol" type="text" placeholder="e.g. AAPL, MSFT, EURUSD=X, USDINR=X" value="{{ chart_form.symbol }}" />
            </div>

            <div class="field">
              <label for="chart_period">Period</label>
              <select id="chart_period" name="chart_period">
                <option value="5d"  {% if chart_form.period == '5d' %}selected{% endif %}>5 days</option>
                <option value="1mo" {% if chart_form.period == '1mo' %}selected{% endif %}>1 month</option>
                <option value="3mo" {% if chart_form.period == '3mo' %}selected{% endif %}>3 months</option>
                <option value="6mo" {% if chart_form.period == '6mo' %}selected{% endif %}>6 months</option>
                <option value="1y"  {% if chart_form.period == '1y' %}selected{% endif %}>1 year</option>
              </select>
            </div>

            <div class="field">
              <button type="submit">Load Candlestick Chart</button>
            </div>

            {% if chart_error %}
              <div class="error"><strong>ERROR:</strong> {{ chart_error }}</div>
            {% endif %}
          </div>
        </form>
      </div>

      <div class="panel result-panel">
        <h2 class="section-title">Price Candlestick</h2>
        {% if chart_data %}
          <p class="muted">SYMBOL: {{ chart_data.symbol }} &nbsp;&nbsp; PERIOD: {{ chart_data.period }}</p>
          <div id="priceCandle" style="width:100%;height:400px;"></div>
        {% else %}
          <p class="muted">ENTER SYMBOL AND EXECUTE â†’ LOAD CANDLESTICK CHART</p>
          <div id="priceCandle" style="width:100%;height:0;"></div>
        {% endif %}

        <hr />

        <h3 class="section-title">Market Movers (Sample Universe)</h3>
        <p class="muted">Computed from a fixed list of large US stocks + FX ETFs using daily % change and volume.</p>

        <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:8px;">
          <div style="flex:1;min-width:220px;">
            <h4 class="section-title">Top 10 Gainers</h4>
            {% if movers.gainers %}
              <table>
                <tr><th>Symbol</th><th>Last</th><th>Change %</th><th>Volume</th></tr>
                {% for row in movers.gainers %}
                  <tr><td>{{ row.symbol }}</td><td>{{ "%.2f"|format(row.last) }}</td><td>{{ "%.2f"|format(row.pct_change) }}</td><td>{{ "%.0f"|format(row.volume) }}</td></tr>
                {% endfor %}
              </table>
            {% else %}
              <p class="muted">NO DATA AVAILABLE.</p>
            {% endif %}
          </div>

          <div style="flex:1;min-width:220px;">
            <h4 class="section-title">Top 10 Losers</h4>
            {% if movers.losers %}
              <table>
                <tr><th>Symbol</th><th>Last</th><th>Change %</th><th>Volume</th></tr>
                {% for row in movers.losers %}
                  <tr><td>{{ row.symbol }}</td><td>{{ "%.2f"|format(row.last) }}</td><td>{{ "%.2f"|format(row.pct_change) }}</td><td>{{ "%.0f"|format(row.volume) }}</td></tr>
                {% endfor %}
              </table>
            {% else %}
              <p class="muted">NO DATA AVAILABLE.</p>
            {% endif %}
          </div>

          <div style="flex:1;min-width:220px;">
            <h4 class="section-title">Most Active</h4>
            {% if movers.active %}
              <table>
                <tr><th>Symbol</th><th>Last</th><th>Change %</th><th>Volume</th></tr>
                {% for row in movers.active %}
                  <tr><td>{{ row.symbol }}</td><td>{{ "%.2f"|format(row.last) }}</td><td>{{ "%.2f"|format(row.pct_change) }}</td><td>{{ "%.0f"|format(row.volume) }}</td></tr>
                {% endfor %}
              </table>
            {% else %}
              <p class="muted">NO DATA AVAILABLE.</p>
            {% endif %}
          </div>
        </div>

        <!-- Added Financial News section -->
        <h3 class="mt-5">ðŸ“° Financial News</h3>
        <div class="list-group">
          {% if news %}
            {% for article in news %}
              <a href="{{ article.url }}" target="_blank" class="list-group-item list-group-item-action" style="background: #001000; border: 1px solid #004422; padding: 10px; margin-bottom: 8px; text-decoration: none; display: block;">
                <h5 class="mb-1" style="color: #00ff7f; margin: 0 0 6px 0;">{{ article.title }}</h5>
                <small style="color: #00aa55;">{{ article.source }} â€¢ {{ article.publishedAt[:10] }}</small><br>
                <a href="{{ article.url }}" target="_blank" style="color: #ff5555; text-decoration: underline; font-size: 12px; margin-top: 6px; display: inline-block;">Read More â†’</a>
              </a>
            {% endfor %}
          {% else %}
            <p class="text-muted">No news available.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- FX PRICING TAB -->
  <div id="fx-tab" class="tab-content {% if active_tab == 'fx' %}active{% endif %}">
    <div class="layout">
      <div class="panel form-panel">
        <form method="post" novalidate>
          <input type="hidden" name="tab_type" value="fx" />
          <div class="form-grid">
            <div class="field">
              <label for="fx_option_type">Option Type</label>
              <select id="fx_option_type" name="fx_option_type">
                <option value="call" {% if fx_form.option_type == 'call' %}selected{% endif %}>Call</option>
                <option value="put" {% if fx_form.option_type == 'put' %}selected{% endif %}>Put</option>
              </select>
            </div>

            <div class="field">
              <label for="fx_model">FX Model</label>
              <select id="fx_model" name="fx_model">
                <option value="gk" {% if fx_form.model == 'gk' %}selected{% endif %}>Garmanâ€“Kohlhagen (European)</option>
                <option value="binomial_eur" {% if fx_form.model == 'binomial_eur' %}selected{% endif %}>Binomial Tree (European)</option>
                <option value="binomial_amer" {% if fx_form.model == 'binomial_amer' %}selected{% endif %}>Binomial Tree (American)</option>
              </select>
            </div>

            <div class="field">
              <label for="fx_symbol">FX Symbol for live spot</label>
              <input id="fx_symbol" name="fx_symbol" type="text" placeholder="EURUSD=X, USDINR=X" value="{{ fx_form.symbol }}" />
              <span class="small-note">Supports yfinance tickers (use exact ticker)</span>
            </div>

            <div class="field">
              <div class="inline-row">
                <input id="fx_use_live_price" name="fx_use_live_price" type="checkbox" value="yes" {% if fx_form.use_live_price == 'yes' %}checked{% endif %} />
                <label for="fx_use_live_price" style="margin:0; text-transform:none; color:#00ff7f; font-size:12px;">Use live FX spot for S</label>
              </div>
            </div>

            <div class="field">
              <label for="fx_S">Spot FX rate S</label>
              <input id="fx_S" name="fx_S" type="number" step="0.0001" value="{{ fx_form.S }}" />
            </div>

            <div class="field">
              <label for="fx_K">Strike K</label>
              <input id="fx_K" name="fx_K" type="number" step="0.0001" value="{{ fx_form.K }}" />
            </div>

            <div class="field">
              <label for="fx_rd">Domestic rate r<sub>d</sub> (0.05 = 5%)</label>
              <input id="fx_rd" name="fx_rd" type="number" step="0.0001" value="{{ fx_form.rd }}" />
            </div>

            <div class="field">
              <label for="fx_rf">Foreign rate r<sub>f</sub> (0.02 = 2%)</label>
              <input id="fx_rf" name="fx_rf" type="number" step="0.0001" value="{{ fx_form.rf }}" />
            </div>

            <div class="field">
              <label for="fx_sigma">Volatility Ïƒ (0.15 = 15%)</label>
              <input id="fx_sigma" name="fx_sigma" type="number" step="0.0001" value="{{ fx_form.sigma }}" />
            </div>

            <div class="field">
              <label for="fx_T">Time to maturity T (years)</label>
              <input id="fx_T" name="fx_T" type="number" step="0.0001" value="{{ fx_form.T }}" />
            </div>

            <div class="field">
              <label for="fx_steps">Binomial steps N</label>
              <input id="fx_steps" name="fx_steps" type="number" value="{{ fx_form.steps }}" />
            </div>

            <div class="field">
              <button type="submit">Price FX Option</button>
            </div>

            {% if fx_error %}
              <div class="error"><strong>ERROR:</strong> {{ fx_error }}</div>
            {% endif %}
          </div>
        </form>
      </div>

      <div class="panel result-panel">
        <h2 class="section-title">FX Result</h2>
        {% if fx_result %}
          <p>MODEL: {{ fx_result.model_label }}<br/>S USED: {{ "%.6f"|format(fx_result.S_used) }}</p>
          <p>OPTION PRICE: {{ "%.6f"|format(fx_result.price) }}</p>

          <h3 class="section-title">FX Greeks (GK)</h3>
          <table>
            <tr><th>Greek</th><th>Value</th></tr>
            <tr><td>Delta</td><td>{{ "%.6f"|format(fx_result.greeks["delta"]) }}</td></tr>
            <tr><td>Gamma</td><td>{{ "%.6f"|format(fx_result.greeks["gamma"]) }}</td></tr>
            <tr><td>Vega</td><td>{{ "%.6f"|format(fx_result.greeks["vega"]) }}</td></tr>
            <tr><td>Theta</td><td>{{ "%.6f"|format(fx_result.greeks["theta"]) }}</td></tr>
            <tr><td>Rho (domestic)</td><td>{{ "%.6f"|format(fx_result.greeks["rho_domestic"]) }}</td></tr>
            <tr><td>Rho (foreign)</td><td>{{ "%.6f"|format(fx_result.greeks["rho_foreign"]) }}</td></tr>
          </table>

          {% if fx_chart %}
            <div class="chart-container">
              <h3 class="section-title">FX Price & Greeks vs Spot</h3>
              <canvas id="fxPriceChart"></canvas>
              <canvas id="fxDeltaChart" style="margin-top:12px;"></canvas>
              <canvas id="fxGammaChart" style="margin-top:12px;"></canvas>
            </div>
          {% endif %}
        {% else %}
          <p class="muted">INPUT PARAMETERS AND EXECUTE â†’ PRICE FX OPTION</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- EQUITY PRICING TAB -->
  <div id="equity-tab" class="tab-content {% if active_tab == 'equity' %}active{% endif %}">
    <div class="layout">
      <div class="panel form-panel">
        <form method="post" novalidate>
          <input type="hidden" name="tab_type" value="equity" />
          <div class="form-grid">
            <div class="field">
              <label for="eq_option_type">Option Type</label>
              <select id="eq_option_type" name="eq_option_type">
                <option value="call" {% if eq_form.option_type == 'call' %}selected{% endif %}>Call</option>
                <option value="put" {% if eq_form.option_type == 'put' %}selected{% endif %}>Put</option>
              </select>
            </div>

            <div class="field">
              <label for="eq_model">Equity Model</label>
              <select id="eq_model" name="eq_model">
                <option value="bs" {% if eq_form.model == 'bs' %}selected{% endif %}>Blackâ€“Scholes (European)</option>
                <option value="binomial_eur" {% if eq_form.model == 'binomial_eur' %}selected{% endif %}>Binomial Tree (European)</option>
                <option value="binomial_amer" {% if eq_form.model == 'binomial_amer' %}selected{% endif %}>Binomial Tree (American)</option>
              </select>
            </div>

            <div class="field">
              <label for="eq_symbol">Stock Symbol for live price</label>
              <input id="eq_symbol" name="eq_symbol" type="text" placeholder="AAPL, MSFT, SAP.DE" value="{{ eq_form.symbol }}" />
              <span class="small-note">Supports US & EU tickers from yfinance</span>
            </div>

            <div class="field">
              <div class="inline-row">
                <input id="eq_use_live_price" name="eq_use_live_price" type="checkbox" value="yes" {% if eq_form.use_live_price == 'yes' %}checked{% endif %} />
                <label for="eq_use_live_price" style="margin:0; text-transform:none; color:#00ff7f; font-size:12px;">Use live stock price for S</label>
              </div>
            </div>

            <div class="field">
              <label for="eq_S">Stock price S</label>
              <input id="eq_S" name="eq_S" type="number" step="0.0001" value="{{ eq_form.S }}" />
            </div>

            <div class="field">
              <label for="eq_K">Strike K</label>
              <input id="eq_K" name="eq_K" type="number" step="0.0001" value="{{ eq_form.K }}" />
            </div>

            <div class="field">
              <label for="eq_r">Risk-free rate r (0.05 = 5%)</label>
              <input id="eq_r" name="eq_r" type="number" step="0.0001" value="{{ eq_form.r }}" />
            </div>

            <div class="field">
              <label for="eq_q">Dividend yield q (0.02 = 2%)</label>
              <input id="eq_q" name="eq_q" type="number" step="0.0001" value="{{ eq_form.q }}" />
            </div>

            <div class="field">
              <label for="eq_sigma">Volatility Ïƒ (0.20 = 20%)</label>
              <input id="eq_sigma" name="eq_sigma" type="number" step="0.0001" value="{{ eq_form.sigma }}" />
            </div>

            <div class="field">
              <label for="eq_T">Time to maturity T (years)</label>
              <input id="eq_T" name="eq_T" type="number" step="0.0001" value="{{ eq_form.T }}" />
            </div>

            <div class="field">
              <label for="eq_steps">Binomial steps N</label>
              <input id="eq_steps" name="eq_steps" type="number" value="{{ eq_form.steps }}" />
            </div>

            <div class="field">
              <button type="submit">Price Stock Option</button>
            </div>

            {% if eq_error %}
              <div class="error"><strong>ERROR:</strong> {{ eq_error }}</div>
            {% endif %}
          </div>
        </form>
      </div>

      <div class="panel result-panel">
        <h2 class="section-title">Stock Result</h2>
        {% if eq_result %}
          <p>MODEL: {{ eq_result.model_label }}<br/>S USED: {{ "%.6f"|format(eq_result.S_used) }}</p>
          <p>OPTION PRICE: {{ "%.6f"|format(eq_result.price) }}</p>

          <h3 class="section-title">Equity Greeks (BS)</h3>
          <table>
            <tr><th>Greek</th><th>Value</th></tr>
            <tr><td>Delta</td><td>{{ "%.6f"|format(eq_result.greeks["delta"]) }}</td></tr>
            <tr><td>Gamma</td><td>{{ "%.6f"|format(eq_result.greeks["gamma"]) }}</td></tr>
            <tr><td>Vega</td><td>{{ "%.6f"|format(eq_result.greeks["vega"]) }}</td></tr>
            <tr><td>Theta</td><td>{{ "%.6f"|format(eq_result.greeks["theta"]) }}</td></tr>
            <tr><td>Rho</td><td>{{ "%.6f"|format(eq_result.greeks["rho"]) }}</td></tr>
          </table>

          {% if eq_chart %}
            <div class="chart-container">
              <h3 class="section-title">Stock Price & Greeks vs Spot</h3>
              <canvas id="eqPriceChart"></canvas>
              <canvas id="eqDeltaChart" style="margin-top:12px;"></canvas>
              <canvas id="eqGammaChart" style="margin-top:12px;"></canvas>
            </div>
          {% endif %}
        {% else %}
          <p class="muted">INPUT PARAMETERS AND EXECUTE â†’ PRICE STOCK OPTION</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- FX OPTION CHAIN TAB (BARCHART REMOVED) -->
  <div id="fx_chain-tab" class="tab-content {% if active_tab == 'fx_chain' %}active{% endif %}">
    <div class="layout">
      <div class="panel form-panel">
        <form method="post" novalidate>
          <input type="hidden" name="tab_type" value="fx_chain" />
          <div class="form-grid">
            <div class="field">
              <label for="fx_chain_symbol">Symbol (Yahoo)</label>
              <input id="fx_chain_symbol" name="fx_chain_contract" type="text"
                     placeholder="Enter Yahoo ticker (e.g. 6E=F, 6EH25, AAPL, EURUSD=X)"
                     value="{{ fx_chain_form.contract or fx_chain_form.root }}" />
              <span class="small-note">Use a Yahoo/yfinance-recognised symbol. The app scrapes Yahoo for option data.</span>
            </div>

            <div class="field">
              <label>Currency or ETF Symbol</label>
              <input type="text" name="fx_chain_root" placeholder="FXE (EUR), FXB (GBP), FXY (JPY), FXA (AUD), FXC (CAD)">
              <small style="color: #00aa55; font-size: 11px;">Use ETF symbols: FXE=EUR, FXB=GBP, FXY=JPY, FXA=AUD, FXC=CAD</small>
            </div>

            <div class="field">
              <button type="submit">Load FX Futures Option Chain</button>
            </div>

            {% if fx_chain_error %}
              <div class="error"><strong>ERROR:</strong> {{ fx_chain_error }}</div>
            {% endif %}
          </div>
        </form>
      </div>

      <div class="panel result-panel">
        <h2 class="section-title">FX Futures Option Chain (Yahoo)</h2>
        {% if fx_chain_calls or fx_chain_puts %}
          <p class="muted">SYMBOL: {{ fx_chain_form.contract or fx_chain_form.root }}</p>

          <h3 class="section-title">Calls</h3>
          <div style="max-height:300px;overflow:auto;">
            <table>
              <tr><th>Expiry</th><th>Strike</th><th>Last</th><th>Bid</th><th>Ask</th><th>IV</th><th>Volume</th><th>O.I.</th></tr>
              {% for row in fx_chain_calls %}
                <tr>
                  <td>{{ row.expirationDate }}</td><td>{{ row.strike }}</td><td>{{ row.last }}</td><td>{{ row.bid }}</td><td>{{ row.ask }}</td><td>{{ row.impliedVolatility }}</td><td>{{ row.volume }}</td><td>{{ row.openInterest }}</td>
                </tr>
              {% endfor %}
            </table>
          </div>

          <h3 class="section-title" style="margin-top:12px;">Puts</h3>
          <div style="max-height:300px;overflow:auto;">
            <table>
              <tr><th>Expiry</th><th>Strike</th><th>Last</th><th>Bid</th><th>Ask</th><th>IV</th><th>Volume</th><th>O.I.</th></tr>
              {% for row in fx_chain_puts %}
                <tr>
                  <td>{{ row.expirationDate }}</td><td>{{ row.strike }}</td><td>{{ row.last }}</td><td>{{ row.bid }}</td><td>{{ row.ask }}</td><td>{{ row.impliedVolatility }}</td><td>{{ row.volume }}</td><td>{{ row.openInterest }}</td>
                </tr>
              {% endfor %}
            </table>
          </div>
        {% else %}
          <p class="muted">ENTER SYMBOL (Yahoo) + EXECUTE â†’ LOAD FX FUTURES OPTION CHAIN</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- STOCK OPTION CHAIN TAB -->
  <div id="equity_chain-tab" class="tab-content {% if active_tab == 'equity_chain' %}active{% endif %}">
    <div class="layout">
      <div class="panel form-panel">
        <form method="post" novalidate>
          <input type="hidden" name="tab_type" value="equity_chain" />
          <div class="form-grid">
            <div class="field">
              <label for="eq_chain_symbol">Stock symbol</label>
              <input id="eq_chain_symbol" name="eq_chain_symbol" type="text" placeholder="AAPL, MSFT, TSLA" value="{{ eq_chain_form.symbol }}" />
            </div>

            <div class="field">
              <label for="eq_chain_expiry">Expiry</label>
              <select id="eq_chain_expiry" name="eq_chain_expiry">
                {% if eq_chain_form.expiries %}
                  {% for e in eq_chain_form.expiries %}
                    <option value="{{ e }}" {% if e == eq_chain_form.expiry %}selected{% endif %}>{{ e }}</option>
                  {% endfor %}
                {% else %}
                  <option value="">(Enter a symbol and submit)</option>
                {% endif %}
              </select>
            </div>

            <div class="field">
              <button type="submit">Load Stock Option Chain</button>
            </div>

            {% if eq_chain_error %}
              <div class="error"><strong>ERROR:</strong> {{ eq_chain_error }}</div>
            {% endif %}
          </div>
        </form>
      </div>

      <div class="panel result-panel">
        <h2 class="section-title">Stock Option Chain</h2>
        {% if eq_chain_calls and eq_chain_puts %}
          <p class="muted">SYMBOL: {{ eq_chain_form.symbol }} &nbsp;&nbsp; EXPIRY: {{ eq_chain_form.expiry }}</p>

          <h3 class="section-title">Calls</h3>
          <div style="max-height:300px;overflow:auto;">
            <table>
              <tr><th>Strike</th><th>Last</th><th>Bid</th><th>Ask</th><th>Volume</th><th>O.I.</th><th>IV</th></tr>
              {% for row in eq_chain_calls %}
                <tr>
                  <td>{{ row.strike }}</td><td>{{ row.lastPrice }}</td><td>{{ row.bid }}</td><td>{{ row.ask }}</td><td>{{ row.volume }}</td><td>{{ row.openInterest }}</td><td>{{ row.impliedVolatility }}</td>
                </tr>
              {% endfor %}
            </table>
          </div>

          <h3 class="section-title" style="margin-top:12px;">Puts</h3>
          <div style="max-height:300px;overflow:auto;">
            <table>
              <tr><th>Strike</th><th>Last</th><th>Bid</th><th>Ask</th><th>Volume</th><th>O.I.</th><th>IV</th></tr>
              {% for row in eq_chain_puts %}
                <tr>
                  <td>{{ row.strike }}</td><td>{{ row.lastPrice }}</td><td>{{ row.bid }}</td><td>{{ row.ask }}</td><td>{{ row.volume }}</td><td>{{ row.openInterest }}</td><td>{{ row.impliedVolatility }}</td>
                </tr>
              {% endfor %}
            </table>
          </div>
        {% else %}
          <p class="muted">ENTER SYMBOL + EXPIRY AND EXECUTE â†’ LOAD STOCK OPTION CHAIN</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- SCENARIO ANALYSIS TAB -->
  <div id="scenario-tab" class="tab-content {% if active_tab == 'scenario' %}active{% endif %}">
    <div class="layout">
      <div class="panel form-panel">
        <h3 class="section-title">âš¡ Scenario Analysis & Risk Dashboard</h3>
        <form method="POST">
          <input type="hidden" name="tab_type" value="scenario">
          
          <div class="form-grid two-col">
            <div class="field">
              <label>Option Type</label>
              <select name="scenario_option_type">
                <option value="call" {% if scenario_form.option_type == 'call' %}selected{% endif %}>Call</option>
                <option value="put" {% if scenario_form.option_type == 'put' %}selected{% endif %}>Put</option>
              </select>
            </div>
            <div class="field">
              <label>Model</label>
              <select name="scenario_model">
                <option value="bs" {% if scenario_form.model == 'bs' %}selected{% endif %}>Black-Scholes</option>
                <option value="binomial_eur" {% if scenario_form.model == 'binomial_eur' %}selected{% endif %}>Binomial (EU)</option>
                <option value="binomial_amer" {% if scenario_form.model == 'binomial_amer' %}selected{% endif %}>Binomial (AM)</option>
              </select>
            </div>
          </div>
          
          <div class="form-grid two-col">
            <div class="field">
              <label>Symbol</label>
              <input type="text" name="scenario_symbol" value="{{ scenario_form.symbol }}" placeholder="AAPL">
            </div>
            <div class="field">
              <label>Spot Price (S)</label>
              <input type="number" name="scenario_S" value="{{ scenario_form.S }}" step="0.01" placeholder="Auto-fetch">
            </div>
          </div>
          
          <div class="inline-row">
            <input type="checkbox" name="scenario_use_live_price" {% if scenario_form.use_live_price %}checked{% endif %}>
            <label style="margin: 0;">Use live price</label>
          </div>
          
          <hr>
          
          <div class="form-grid two-col">
            <div class="field">
              <label>Strike (K)</label>
              <input type="number" name="scenario_K" value="{{ scenario_form.K }}" step="0.01" placeholder="=S">
            </div>
            <div class="field">
              <label>Risk-free Rate (r)</label>
              <input type="number" name="scenario_r" value="{{ scenario_form.r }}" step="0.001" placeholder="0.05">
            </div>
          </div>
          
          <div class="form-grid two-col">
            <div class="field">
              <label>Dividend Yield (q)</label>
              <input type="number" name="scenario_q" value="{{ scenario_form.q }}" step="0.001" placeholder="0.0">
            </div>
            <div class="field">
              <label>Volatility (Ïƒ)</label>
              <input type="number" name="scenario_sigma" value="{{ scenario_form.sigma }}" step="0.01" placeholder="0.2">
            </div>
          </div>
          
          <div class="field">
            <label>Time to Expiry (T, years)</label>
            <input type="number" name="scenario_T" value="{{ scenario_form.T }}" step="0.01" placeholder="1.0">
          </div>
          
          <button type="submit" style="width: 100%; margin-top: 12px;">Run Scenario Analysis</button>
        </form>
        
        {% if scenario_error %}
          <div class="error">{{ scenario_error }}</div>
        {% endif %}
      </div>
      
      {% if scenario_result %}
        <div class="panel result-panel">
          <h3 class="section-title">ðŸ“Š Risk Dashboard</h3>
          <table>
            <thead>
              <tr>
                <th>Scenario</th>
                <th>Spot</th>
                <th>Vol</th>
                <th>Rate</th>
                <th>Option Price</th>
                <th>P&L</th>
              </tr>
            </thead>
            <tbody>
              {% for scenario_name, data in scenario_result.items() %}
                <tr>
                  <td style="color: #00ff7f; font-weight: bold;">{{ scenario_name }}</td>
                  <td>{{ "%.4f"|format(data.S) }}</td>
                  <td>{{ "%.2f"|format(data.sigma * 100) }}%</td>
                  <td>{{ "%.2f"|format(data.r * 100) }}%</td>
                  <td style="color: #00ff7f;">{{ "%.4f"|format(data.price) }}</td>
                  <td style="color: {% if data.pnl >= 0 %}#00ff7f{% else %}#ff5555{% endif %};">{{ "%.4f"|format(data.pnl) }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <p class="muted" style="margin-top: 12px;">Analysis shows P&L impact from spot, volatility, and rate changes.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- MODEL COMPARISON TAB -->
  <div id="comparison-tab" class="tab-content {% if active_tab == 'comparison' %}active{% endif %}">
    <div class="layout">
      <div class="panel form-panel">
        <h3 class="section-title">ðŸ”„ Pricing Model Comparison</h3>
        <form method="POST">
          <input type="hidden" name="tab_type" value="comparison">
          
          <div class="form-grid two-col">
            <div class="field">
              <label>Option Type</label>
              <select name="comparison_option_type">
                <option value="call" {% if comparison_form.option_type == 'call' %}selected{% endif %}>Call</option>
                <option value="put" {% if comparison_form.option_type == 'put' %}selected{% endif %}>Put</option>
              </select>
            </div>
            <div class="field">
              <label>Symbol</label>
              <input type="text" name="comparison_symbol" value="{{ comparison_form.symbol }}" placeholder="AAPL">
            </div>
          </div>
          
          <div class="form-grid two-col">
            <div class="field">
              <label>Spot Price (S)</label>
              <input type="number" name="comparison_S" value="{{ comparison_form.S }}" step="0.01" placeholder="Auto-fetch">
            </div>
            <div class="field">
              <label>Strike (K)</label>
              <input type="number" name="comparison_K" value="{{ comparison_form.K }}" step="0.01" placeholder="=S">
            </div>
          </div>
          
          <div class="inline-row">
            <input type="checkbox" name="comparison_use_live_price" {% if comparison_form.use_live_price %}checked{% endif %}>
            <label style="margin: 0;">Use live price</label>
          </div>
          
          <hr>
          
          <div class="form-grid two-col">
            <div class="field">
              <label>Risk-free Rate (r)</label>
              <input type="number" name="comparison_r" value="{{ comparison_form.r }}" step="0.001" placeholder="0.05">
            </div>
            <div class="field">
              <label>Dividend Yield (q)</label>
              <input type="number" name="comparison_q" value="{{ comparison_form.q }}" step="0.001" placeholder="0.0">
            </div>
          </div>
          
          <div class="form-grid two-col">
            <div class="field">
              <label>Volatility (Ïƒ)</label>
              <input type="number" name="comparison_sigma" value="{{ comparison_form.sigma }}" step="0.01" placeholder="0.2">
            </div>
            <div class="field">
              <label>Time to Expiry (T)</label>
              <input type="number" name="comparison_T" value="{{ comparison_form.T }}" step="0.01" placeholder="1.0">
            </div>
          </div>
          
          <div class="field">
            <label>Binomial Steps</label>
            <input type="number" name="comparison_steps" value="{{ comparison_form.steps }}" step="10" placeholder="100">
          </div>
          
          <button type="submit" style="width: 100%; margin-top: 12px;">Compare Models</button>
        </form>
        
        {% if comparison_error %}
          <div class="error">{{ comparison_error }}</div>
        {% endif %}
      </div>
      
      {% if comparison_result %}
        <div class="panel result-panel">
          <h3 class="section-title">ðŸ“ˆ Model Comparison Results</h3>
          <table>
            <thead>
              <tr>
                <th>Model</th>
                <th>Price</th>
                <th>Delta</th>
                <th>Gamma</th>
                <th>Vega</th>
                <th>Theta</th>
              </tr>
            </thead>
            <tbody>
              {% for model_name, data in comparison_result.items() %}
                <tr>
                  <td style="color: #00ff7f; font-weight: bold;">{{ model_name }}</td>
                  <td>{{ "%.4f"|format(data.price) }}</td>
                  <td>{{ "%.4f"|format(data.delta) }}</td>
                  <td>{{ "%.6f"|format(data.gamma) }}</td>
                  <td>{{ "%.4f"|format(data.vega) }}</td>
                  <td>{{ "%.4f"|format(data.theta) }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <p class="muted" style="margin-top: 12px;">Compare pricing and Greeks across different models.</p>
        </div>
      {% endif %}
    </div>
    
    <!-- COMPARISON CHARTS -->
    {% if comparison_result %}
      <div class="layout" style="margin-top: 20px;">
        <div class="panel" style="flex: 1;">
          <h4 style="color: #00ff7f; margin: 0 0 12px 0;">ðŸ’° Price Comparison</h4>
          <canvas id="comparisonPriceChart" style="max-height: 300px;"></canvas>
        </div>
        <div class="panel" style="flex: 1;">
          <h4 style="color: #00ff7f; margin: 0 0 12px 0;">ðŸ“Š Greeks Heatmap</h4>
          <canvas id="comparisonGreeksChart" style="max-height: 300px;"></canvas>
        </div>
      </div>

      <script>
        // Price Comparison Chart
        const comparisonData = {{ comparison_result|tojson }};
        const modelNames = Object.keys(comparisonData);
        const prices = modelNames.map(m => comparisonData[m].price);
        const deltas = modelNames.map(m => comparisonData[m].delta);
        const gammas = modelNames.map(m => comparisonData[m].gamma);
        const vegas = modelNames.map(m => comparisonData[m].vega);
        const thetas = modelNames.map(m => comparisonData[m].theta);

        const priceCtx = document.getElementById('comparisonPriceChart').getContext('2d');
        new Chart(priceCtx, {
          type: 'bar',
          data: {
            labels: modelNames,
            datasets: [
              {
                label: 'Option Price',
                data: prices,
                backgroundColor: '#00ff7f',
                borderColor: '#00aa55',
                borderWidth: 2,
                borderRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, labels: { color: '#00ff7f' } }
            },
            scales: {
              y: { ticks: { color: '#00ff7f' }, grid: { color: '#003300' } },
              x: { ticks: { color: '#00ff7f' }, grid: { color: '#003300' } }
            }
          }
        });

        // Greeks Comparison (Radar/Polar Chart)
        const greeksCtx = document.getElementById('comparisonGreeksChart').getContext('2d');
        const colors = ['#00ff7f', '#ff5555', '#ffff00', '#00aaff'];
        const datasets = [];
        modelNames.forEach((model, idx) => {
          datasets.push({
            label: model,
            data: [
              comparisonData[model].delta,
              comparisonData[model].gamma * 1000, // Scale gamma for visibility
              comparisonData[model].vega,
              comparisonData[model].theta
            ],
            borderColor: colors[idx % colors.length],
            backgroundColor: colors[idx % colors.length] + '33',
            borderWidth: 2,
            tension: 0.3
          });
        });

        new Chart(greeksCtx, {
          type: 'radar',
          data: {
            labels: ['Delta', 'Gamma (Ã—1000)', 'Vega', 'Theta'],
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { labels: { color: '#00ff7f' } }
            },
            scales: {
              r: {
                ticks: { color: '#00ff7f' },
                grid: { color: '#003300' }
              }
            }
          }
        });
      </script>
    {% endif %}
  </div>

  <script>
    function showTab(tab) {
      const tabIds = ['chart','fx','equity','fx_chain','equity_chain', 'scenario', 'comparison'];
      for (const id of tabIds) {
        const div = document.getElementById(id + '-tab');
        if (div) div.classList.toggle('active', id === tab);
      }
      const btns = document.getElementsByClassName('tab-btn');
      for (let i=0;i<btns.length;i++) btns[i].classList.toggle('active', ['chart','fx','equity','fx_chain','equity_chain', 'scenario', 'comparison'][i] === tab);
    }

    window.addEventListener('load', function () {
      showTab('{{ active_tab }}');

      if (typeof Chart !== 'undefined') {
        Chart.defaults.color = '#00ff7f';
        Chart.defaults.borderColor = '#004422';
        Chart.defaults.font.family = 'Courier New, monospace';
      }

      {% if chart_data %}
        const dates = {{ chart_data.dates | tojson }};
        const open  = {{ chart_data.open  | tojson }};
        const high  = {{ chart_data.high  | tojson }};
        const low   = {{ chart_data.low   | tojson }};
        const close = {{ chart_data.close | tojson }};

        const candleTrace = {
          x: dates,
          open: open,
          high: high,
          low: low,
          close: close,
          type: 'candlestick',
          name: '{{ chart_data.symbol }}',
          increasing: { line: { color: '#00ff7f' } },
          decreasing: { line: { color: '#ff4444' } }
        };

        const candleLayout = {
          dragmode: 'zoom',
          margin: { r: 10, t: 25, b: 40, l: 50 },
          xaxis: { title: 'Date', color: '#00ff7f', gridcolor: '#003315' },
          yaxis: { title: 'Price', color: '#00ff7f', gridcolor: '#003315' },
          paper_bgcolor: '#000000',
          plot_bgcolor: '#000000',
          font: { color: '#00ff7f', family: 'Courier New, monospace' }
        };

        Plotly.newPlot('priceCandle', [candleTrace], candleLayout, { responsive: true });
      {% endif %}

      {% if fx_chart %}
        const fxS = {{ fx_chart.S | tojson }};
        const fxPrice = {{ fx_chart.price | tojson }};
        const fxDelta = {{ fx_chart.delta | tojson }};
        const fxGamma = {{ fx_chart.gamma | tojson }};

        new Chart(document.getElementById('fxPriceChart'), {
          type: 'line',
          data: { labels: fxS, datasets: [{ label: 'FX Option Price vs Spot', data: fxPrice, fill: false, tension: 0.2, borderColor: '#00ff7f', pointRadius: 0 }]},
          options: { scales: { x: { title: { display: true, text: 'Spot S' }}, y: { title: { display: true, text: 'Option Price' }}} }
        });

        new Chart(document.getElementById('fxDeltaChart'), {
          type: 'line',
          data: { labels: fxS, datasets: [{ label: 'FX Delta vs Spot', data: fxDelta, fill: false, tension: 0.2, borderColor: '#00ff7f', pointRadius: 0 }]},
          options: { scales: { x: { title: { display: true, text: 'Spot S' }}, y: { title: { display: true, text: 'Delta' }}} }
        });

        new Chart(document.getElementById('fxGammaChart'), {
          type: 'line',
          data: { labels: fxS, datasets: [{ label: 'FX Gamma vs Spot', data: fxGamma, fill: false, tension: 0.2, borderColor: '#00ff7f', pointRadius: 0 }]},
          options: { scales: { x: { title: { display: true, text: 'Spot S' }}, y: { title: { display: true, text: 'Gamma' }}} }
        });
      {% endif %}

      {% if eq_chart %}
        const eqS = {{ eq_chart.S | tojson }};
        const eqPrice = {{ eq_chart.price | tojson }};
        const eqDelta = {{ eq_chart.delta | tojson }};
        const eqGamma = {{ eq_chart.gamma | tojson }};

        new Chart(document.getElementById('eqPriceChart'), {
          type: 'line',
          data: { labels: eqS, datasets: [{ label: 'Stock Option Price vs Spot', data: eqPrice, fill: false, tension: 0.2, borderColor: '#00ff7f', pointRadius: 0 }]},
          options: { scales: { x: { title: { display: true, text: 'Spot S' }}, y: { title: { display: true, text: 'Option Price' }}} }
        });

        new Chart(document.getElementById('eqDeltaChart'), {
          type: 'line',
          data: { labels: eqS, datasets: [{ label: 'Stock Delta vs Spot', data: eqDelta, fill: false, tension: 0.2, borderColor: '#00ff7f', pointRadius: 0 }]},
          options: { scales: { x: { title: { display: true, text: 'Spot S' }}, y: { title: { display: true, text: 'Delta' }}} }
        });

        new Chart(document.getElementById('eqGammaChart'), {
          type: 'line',
          data: { labels: eqS, datasets: [{ label: 'Stock Gamma vs Spot', data: eqGamma, fill: false, tension: 0.2, borderColor: '#00ff7f', pointRadius: 0 }]},
          options: { scales: { x: { title: { display: true, text: 'Spot S' }}, y: { title: { display: true, text: 'Gamma' }}} }
        });
      {% endif %}
    });
  </script>
</body>
</html>

